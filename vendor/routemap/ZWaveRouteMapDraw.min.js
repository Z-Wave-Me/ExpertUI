window.ZWaveRoutesPlotLib=function(){function A(b,h,g,p,n,r){r||(r=function(v){return v});return r((b-h)/(g-h))*(n-p)+p}function J(b){switch(b){case "Controller":return k.color.controller;case "FLiRS":return k.color.flirs;case "Sleeping":return k.color.sleeping;case "Routing":return k.color.routing;case "Phantom":return k.color.phantom;default:throw"Unknow type:"+b;}}function w(b){d3.select(b).style("display","block");setTimeout(function(){d3.select(b).style("display","none")},5E3)}function x(b){d3.select(b).style("display",
"none")}function q(b){this.zna=b;this.data={nodes:this.zna.getNodes(),links:this.zna.getLinks()};this.selectedNode=null;this.initPlot();this.initNodes();this.nodesMoveAllowed=!1;d3.select("#IMA_too_few_nodes").style("display",3>this.data.nodes.length?"block":"none");d3.select("#IMA_absent").style("display",this.zna.getStats().haveIMA?"none":"block");x("#manualRouteErrorBatteryToBattery");x("#manualRouteErrorBatteryRepeater");x("#manualRouteSet");x("#manualRouteInfo")}var k={color:{current:"coral",
routedFor:"sandybrown",association:"red",problematic:"orange",controller:"lightgray",flirs:"darkgreen",sleeping:"lightblue",routing:"black",phantom:"red"},threshold:{explores:.1,retries:.2},status:{dead:"Node is dead",alive:"Node is alive"},routes:{othersOpacity:"0.3"},viewport:{sizeX:200,sizeY:100}};q.prototype.initPlot=function(){var b=d3.select("#svg");b.append("svg:defs").append("svg:marker").attr("id","triangle").attr("refX",8).attr("refY",2).attr("markerWidth",30).attr("markerHeight",30).attr("orient",
"auto").append("path").attr("d","M 0 0 4 2 0 4 1 2");b.append("rect").style("fill","none").style("pointer-events","all");this.chartLayer=b.append("g").classed("chartLayer",!0).attr("width",1).attr("height",1).attr("transform","translate(0,0)")};q.prototype.initNodes=function(){function b(){c.curNode?h(c.curNode):g();var a=d3.selectAll('input[name="ShowMode"]').filter(function(){return this.checked}).node().id;d3.selectAll(".ShowModeAnnotation").style("display","none");d3.selectAll(".ShowModeAnnotation."+
a).style("display","table-row")}function h(a){c.curNode=a;if(c.manualRouteMode)y(),B(a.id);else if(d3.select("#ShowModeOutgoingRoutes").node().checked&&F(c.zna.getMyNodeId(),a.id,d3.select("#ShowPriorityRoute").node().checked),d3.select("#ShowModeIncomingRoutes").node().checked&&F(a.id,c.zna.getMyNodeId(),d3.select("#ShowPriorityRoute").node().checked),d3.select("#ShowModeAllRoutes").node().checked&&C(),d3.select("#ShowModeNodeRoutes").node().checked){C();var f=a.id;d3.select(".links").selectAll('line[id1="'+
f+'"]').attr("opacity","1");d3.select(".links").selectAll('line[id2="'+f+'"]').attr("opacity","1")}d3.select("#ShowRepeatingFor").node().checked&&K(a.id);d3.selectAll('circle[id="id'+a.id+'"]').attr("fill",k.color.current);d3.select("#ShowAssociations").node().checked&&L(a.id);G(a);H(a)}function g(a){c.curNode=null;c.manualRouteMode?(y(),B()):(d3.select("#ShowModeOutgoingRoutes").node().checked&&y(),d3.select("#ShowModeIncomingRoutes").node().checked&&y(),d3.select("#ShowModeAllRoutes").node(),d3.select("#ShowModeNodeRoutes").node().checked&&
C());M();G();H()}function p(a){c.manualRouteMode&&-1===c.manualRoute.indexOf(a.id)&&(c.manualRouteAppendHop(a),B())}function n(a){c.nodesMoveAllowed&&(d3.event.active||D.alphaTarget(1).restart(),a.fx=a.x,a.fy=a.y)}function r(a){c.nodesMoveAllowed&&(a.fx=d3.event.x,a.fy=d3.event.y)}function v(a){c.nodesMoveAllowed&&(0>a.x&&(a.x=0),0>a.y&&(a.y=0),200<a.x&&(a.x=200),100<a.y&&(a.y=100),d3.event.active||D.alphaTarget(0),a.fx=null,a.fy=null)}function C(){d3.select(".links").selectAll("line").attr("stroke",
"black").attr("stroke-width",function(a){return 0==a.usage12?0:(a=a.rssi12||a.rssi21?(a.rssi12+a.rssi21)/((a.rssi12?1:0)+(a.rssi21?1:0)):0)?A(a,1,.4,.6,2.5):.3}).attr("stroke-dasharray",function(a){return"2,"+Math.round(10*a.fails12).toString()}).attr("opacity",d3.select("#ShowModeAllRoutes").node().checked?"1":d3.select("#ShowAllRoutes").node().checked?k.routes.othersOpacity:"0")}function y(){d3.select(".links").selectAll("line").attr("opacity","0")}function B(a){var f=c.manualRoute[c.manualRoute.length-
1];5<c.manualRoute.length&&(a=0);d3.select(".manualRoute").selectAll("line").attr("stroke","yellow").attr("stroke-width","1.7").attr("stroke-dasharray","2,0").attr("opacity",function(){var l=parseInt(this.attributes.id1.value,10),m=parseInt(this.attributes.id2.value,10),e;return l===f&&m===a||m===f&&l===a||-1!==(e=c.manualRoute.indexOf(l))&&c.manualRoute[e+1]===m||-1!==(e=c.manualRoute.indexOf(m))&&c.manualRoute[e+1]===l?"1":"0"})}function F(a,f,l){var m=c.zna.getTrajectoryLinkMap(a,f);if(l){var e=
c.zna.getNodePriorityRoutes(a)[f];e&&(e.unshift(a),e.push(f))}d3.select(".links").selectAll("line").attr("stroke",function(){var d=parseInt(this.attributes.id1.value,10),t=parseInt(this.attributes.id2.value,10),z;return l&&e&&(-1!==(z=e.indexOf(d))&&e[z+1]===t||-1!==(z=e.indexOf(t))&&e[z+1]===d)?"yellow":"black"}).attr("stroke-width",function(d){d=c.zna.getStatUsage(m,d.source.id,d.target.id)||c.zna.getStatUsage(m,d.target.id,d.source.id);return A(d,0,1,.3,1.7,Math.sqrt)}).attr("stroke-dasharray",
function(d){return"2,"+Math.round(10*(c.zna.getStatFailRate(m,d.source.id,d.target.id)||c.zna.getStatFailRate(m,d.target.id,d.source.id))).toString()}).attr("opacity",function(d){return c.zna.getStatUsage(m,d.source.id,d.target.id)||c.zna.getStatUsage(m,d.target.id,d.source.id)?"1":"0"})}function M(){d3.selectAll("circle").attr("fill",function(a){return a.color}).attr("stroke",function(a){return a.color}).attr("stroke-width","0px")}function K(a){var f=c.zna.getNodesRoutedFor(a);d3.selectAll("circle").attr("fill",
function(l){return-1!==f.indexOf(l.id)?k.color.routedFor:l.color})}function L(a){d3.selectAll("circle").filter(function(f){return-1!==c.zna.getNodeAssociations(a).indexOf(f.id)}).attr("stroke",k.color.association).attr("stroke-width",.2)}function G(a){d3.select("#annotation-id").html(a?a.id:"");d3.select("#annotation-name").html(a?a.name:"");d3.select("#annotation-type").html(a?a.type:"");d3.select("#annotation-dead").html(a?a.dead?k.status.dead:k.status.alive:"");d3.select("#annotation-associations").html(a?
c.zna.getNodeAssociations(a.id).join(", "):"")}function H(a){if(a){if(a.id!==c.zna.getMyNodeId()){var f=c.zna.getMyNodeId(),l=c.zna.getTrajectoryStats(f,a.id),m=c.zna.getTrajectoryStats(a.id,f);d3.select("#annotation-delivery-rate").html(Math.round(100*l.deliveryRate)+"%");d3.select("#annotation-n-reroutes").html(isFinite(l.minOutHops)?Math.round(100*l.retries)+"%":"N/A");d3.select("#annotation-explore-frames").html(Math.round(100*m.explores)+"%");d3.select("#annotation-routes-to").html(l.routes.map(function(e){var d=
e.slice();d.unshift(f);d.push(a.id);d=d.join("&rarr;");c.zna.isPriorityRoute(f,a.id,e)&&(d="<b>"+d+"</b>");return d}).filter(function(e,d,t){return t.indexOf(e)===d}).join("<br/>"));d3.select("#annotation-routes-from").html(m.routes.map(function(e){var d=e.slice();d.unshift(a.id);d.push(f);d=d.join("&rarr;");c.zna.isPriorityRoute(a.id,f,e)&&(d="<b>"+d+"</b>");return d}).filter(function(e,d,t){return t.indexOf(e)===d}).join("<br/>"));d3.select("#annotation-in-packets").html(m.received);d3.select("#annotation-out-packets").html(l.sent);
d3.select("#annotation-routes-for").html(c.zna.getNodesRoutedFor(a.id).join(", "))}}else d3.select("#annotation-delivery-rate").html(""),d3.select("#annotation-n-reroutes").html(""),d3.select("#annotation-explore-frames").html(""),d3.select("#annotation-routes-to").html(""),d3.select("#annotation-routes-from").html(""),d3.select("#annotation-in-packets").html(""),d3.select("#annotation-out-packets").html(""),d3.select("#annotation-routes-for").html("")}var c=this,D=d3.forceSimulation(this.data.nodes).force("linkForce",
d3.forceLink(this.data.links).id(function(a){return a.id}).distance(function(a){return 400}).strength(0));this.data.nodes.map(function(a){a.r=A(a.usage,0,1,15,50,Math.sqrt)/8;a.color=J(a.type)});var u=this.data.nodes.filter(function(a){return null===a.x||null===a.y});if(1===u.length)u[0].x=k.viewport.sizeX/2,u[0].y=k.viewport.sizeY/2;else{var I=Math.min(k.viewport.sizeX,k.viewport.sizeY)/3,E=0;u.forEach(function(a){a.id===c.zna.getMyNodeId()?a.x=a.y=0:(a.x=I*Math.cos(2*Math.PI/(u.length-1)*E),a.y=
I*Math.sin(2*Math.PI/(u.length-1)*E),E++);a.x+=k.viewport.sizeX/2;a.y+=k.viewport.sizeY/2})}var N=this.chartLayer.append("g").attr("class","links").selectAll("line").data(this.data.links).enter().append("line").attr("id1",function(a){return a.source.id}).attr("id2",function(a){return a.target.id});this.chartLayer.append("g").attr("class","manualRoute");var O=this.chartLayer.append("g").attr("class","nodes").selectAll("circle").data(this.data.nodes).enter().append("circle").attr("id",function(a){return"id"+
a.id}).attr("r",function(a){return a.r}).attr("fill",function(a){return a.color}).attr("mask",function(a){return a.dead?"url(#mask)":""}).call(d3.drag().on("start",n).on("drag",r).on("end",v)).on("mouseover",h).on("mouseout",g).on("click",p),P=this.chartLayer.append("g").attr("class","labels").selectAll("text").data(this.data.nodes).enter().append("text").text(function(a){return a.id}).attr("font-size",2).attr("fill","white").attr("text-anchor","middle").attr("alignment-baseline","middle").attr("transform",
function(a){return"translate(0,0)"}).call(d3.drag().on("start",n).on("drag",r).on("end",v)).on("mouseover",h).on("mouseout",g).on("click",p);d3.select("#ShowModeOutgoingRoutes").on("change",b);d3.select("#ShowModeIncomingRoutes").on("change",b);d3.select("#ShowModeAllRoutes").on("change",b);d3.select("#ShowModeNodeRoutes").on("change",b);d3.selection.prototype.click=function(){this.each(function(){this.dispatchEvent(new MouseEvent("click"))})};D.on("tick",function(){N.attr("x1",function(a){return a.source.x}).attr("y1",
function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y});O.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y});P.attr("x",function(a){return a.x}).attr("y",function(a){return a.y})});b()};q.prototype.manualRouteStart=function(b,h){this.setManualRoute=h;this.manualRouteMode=!0;this.manualRoute=[];this.manualRouteClear();b&&this.manualRouteAppendHop(b);w("#manualRouteInfo")};q.prototype.manualRouteClear=function(){d3.select(".manualRoute").selectAll("*").remove()};
q.prototype.manualRouteAppendHop=function(b){var h=this;-1===this.manualRoute.indexOf(b.id)&&(this.manualRoute.push(b.id),d3.select(".manualRoute").selectAll("line").filter(function(){var g=parseInt(this.attributes.id1.value,10),p=parseInt(this.attributes.id2.value,10),n;return(-1===(n=h.manualRoute.indexOf(g))||h.manualRoute[n+1]!==p)&&(-1===(n=h.manualRoute.indexOf(p))||h.manualRoute[n+1]!==g)}).remove(),this.data.nodes.forEach(function(g){g.id!==b.id&&-1===h.manualRoute.indexOf(g.id)&&d3.select(".manualRoute").append("line").attr("id1",
b.id).attr("x1",b.x).attr("y1",b.y).attr("id2",g.id).attr("x2",g.x).attr("y2",g.y)}))};q.prototype.manualRouteTerminate=function(b){var h=this;this.manualRouteMode=!1;this.manualRouteClear();if(b&&this.setManualRoute){b=this.manualRoute[0];var g=this.manualRoute[this.manualRoute.length-1],p=this.manualRoute.slice(1,-1);this.zna.isListening(b)||this.zna.isListening(g)?p.length&&p.map(function(n){return!h.zna.isListening(n)}).some(function(n){return n})?w("#manualRouteErrorBatteryRepeater"):(this.setManualRoute(this.manualRoute.slice()),
this.zna.updatePriorityRoute(b,g,p),w("#manualRouteSet")):w("#manualRouteErrorBatteryToBattery")}};q.prototype.getPriorityRoutes=function(){return this.zna.getPriorityRoutes()};q.prototype.updatePriorityRoute=function(b,h,g){return this.zna.updatePriorityRoute(b,h,g)};q.prototype.allowMoveNodes=function(b){void 0!=b&&(this.nodesMoveAllowed=!this.nodesMoveAllowed);return this.nodesMoveAllowed};q.prototype.getNodesPositions=function(){return this.data.nodes.map(function(b){return{id:b.id,x:b.x,y:b.y}})};
q.prototype.getStats=function(){var b=this.zna.getStats();return{gatheringPeriod:Math.ceil((b.startStatistics-b.endStatistics)/60/60),packetsNum:b.packetsCount,missingStats:b.nodeNoStatistics.join(", ")}};return q}();window.ZWaveRoutesPlotLib.prototype.getNodesPositions=window.ZWaveRoutesPlotLib.prototype.getNodesPositions;window.ZWaveRoutesPlotLib.prototype.allowMoveNodes=window.ZWaveRoutesPlotLib.prototype.allowMoveNodes;window.ZWaveRoutesPlotLib.prototype.manualRouteStart=window.ZWaveRoutesPlotLib.prototype.manualRouteStart;
window.ZWaveRoutesPlotLib.prototype.getPriorityRoutes=window.ZWaveRoutesPlotLib.prototype.getPriorityRoutes;window.ZWaveRoutesPlotLib.prototype.updatePriorityRoute=window.ZWaveRoutesPlotLib.prototype.updatePriorityRoute;window.ZWaveRoutesPlotLib.prototype.getStats=window.ZWaveRoutesPlotLib.prototype.getStats;